#! /bin/bash
#SBATCH -J gaussian-rodinia-3.1-_s_16.accelsim-commit-_modified_0.0_25-09-09-20-25-52gpgpu-sim_git-commit-d9e6e135_modified_3.0
#SBATCH --threads-per-core=1
#SBATCH --cpus-per-task=1
#SBATCH --nodes=1
#SBATCH --mem-per-cpu=1G
#SBACTH --time=200:00:00,
#SBATCH -p batch
#SBATCH --mail-type=END,FAIL
#SBATCH --export=ALL
#SBATCH --output=/tmp/gaussian-rodinia-3.1-_s_16.accelsim-commit-_modified_0.0_25-09-09-20-25-52gpgpu-sim_git-commit-d9e6e135_modified_3.0.o%j
#SBATCH --error=/tmp/gaussian-rodinia-3.1-_s_16.accelsim-commit-_modified_0.0_25-09-09-20-25-52gpgpu-sim_git-commit-d9e6e135_modified_3.0.e%j

copy_output() {
    mv /tmp/gaussian-rodinia-3.1-_s_16.accelsim-commit-_modified_0.0_25-09-09-20-25-52gpgpu-sim_git-commit-d9e6e135_modified_3.0.e1 ./gaussian-rodinia-3.1-_s_16.accelsim-commit-_modified_0.0_25-09-09-20-25-52gpgpu-sim_git-commit-d9e6e135_modified_3.0.e1
    mv /tmp/gaussian-rodinia-3.1-_s_16.accelsim-commit-_modified_0.0_25-09-09-20-25-52gpgpu-sim_git-commit-d9e6e135_modified_3.0.o1 ./gaussian-rodinia-3.1-_s_16.accelsim-commit-_modified_0.0_25-09-09-20-25-52gpgpu-sim_git-commit-d9e6e135_modified_3.0.o1
}

trap copy_output ERR

#citing https://stackoverflow.com/questions/35800082/how-to-trap-err-when-using-set-e-in-bash
#Setting -E alongside -e makes any trap on ERR inherited by shell funcs, command substitutions and commands executed in a subshell environment
set -eE

if [ "$GPGPUSIM_SETUP_ENVIRONMENT_WAS_RUN" != "1" ]; then
    export GPGPUSIM_ROOT=/accel-sim-framework/gpu-simulator/gpgpu-sim
    source $GPGPUSIM_ROOT/setup_environment
else
    echo "Skipping setup_environment - already set"
fi

echo "doing: export -n PTX_SIM_USE_PTX_FILE"
export -n PTX_SIM_USE_PTX_FILE
echo "doing: export LD_LIBRARY_PATH=/accel-sim-framework/util/job_launching/../../sim_run_11.1/gpgpu-sim-builds/accelsim-commit-_modified_0.0_25-09-09-20-25-52gpgpu-sim_git-commit-d9e6e135_modified_3.0:$LD_LIBRARY_PATH"
export LD_LIBRARY_PATH=/accel-sim-framework/util/job_launching/../../sim_run_11.1/gpgpu-sim-builds/accelsim-commit-_modified_0.0_25-09-09-20-25-52gpgpu-sim_git-commit-d9e6e135_modified_3.0:$LD_LIBRARY_PATH
echo "doing: cd /accel-sim-framework/util/job_launching/../../sim_run_11.1/gaussian-rodinia-3.1/_s_16/QV100-Accelwattch_SASS_SIM"
cd /accel-sim-framework/util/job_launching/../../sim_run_11.1/gaussian-rodinia-3.1/_s_16/QV100-Accelwattch_SASS_SIM
echo "doing: export OPENCL_CURRENT_TEST_PATH=/accel-sim-framework/util/job_launching/../../sim_run_11.1/gaussian-rodinia-3.1/_s_16/QV100-Accelwattch_SASS_SIM"
export OPENCL_CURRENT_TEST_PATH=/accel-sim-framework/util/job_launching/../../sim_run_11.1/gaussian-rodinia-3.1/_s_16/QV100-Accelwattch_SASS_SIM
echo "doing: export OPENCL_REMOTE_GPU_HOST=REPLACE_REMOTE_HOST"
export OPENCL_REMOTE_GPU_HOST=REPLACE_REMOTE_HOST
echo "doing "

echo "doing: export PATH=/accel-sim-framework/gpu-simulator/gpgpu-sim/bin:/usr/local/cuda/bin:/root/.vscode-server/bin/6f17636121051a53c88d3e605c491d22af2ba755/bin/remote-cli:/usr/local/nvidia/bin:/usr/local/cuda/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/root/.vscode-server/data/User/globalStorage/github.copilot-chat/debugCommand"
export PATH=/accel-sim-framework/gpu-simulator/gpgpu-sim/bin:/usr/local/cuda/bin:/root/.vscode-server/bin/6f17636121051a53c88d3e605c491d22af2ba755/bin/remote-cli:/usr/local/nvidia/bin:/usr/local/cuda/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/root/.vscode-server/data/User/globalStorage/github.copilot-chat/debugCommand

# Uncomment to force blocking torque launches
# this needs to be commented for concurrent kernel ptx mode
echo "doing export CUDA_LAUNCH_BLOCKING=1"
export CUDA_LAUNCH_BLOCKING=1


# echo "doing:  /accel-sim-framework/util/job_launching/../../sim_run_11.1/gpgpu-sim-builds/accelsim-commit-_modified_0.0_25-09-09-20-25-52gpgpu-sim_git-commit-d9e6e135_modified_3.0/accel-sim.out  -config ./gpgpusim.config -trace ./traces/kernelslist.g"
#  /accel-sim-framework/util/job_launching/../../sim_run_11.1/gpgpu-sim-builds/accelsim-commit-_modified_0.0_25-09-09-20-25-52gpgpu-sim_git-commit-d9e6e135_modified_3.0/accel-sim.out  -config ./gpgpusim.config -trace ./traces/kernelslist.g
./justrun.sh
copy_output